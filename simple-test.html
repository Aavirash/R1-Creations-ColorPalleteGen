<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=240, initial-scale=1.0, user-scalable=no">
    <title>Simple Color Test</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .color-swatch {
            width: 40px;
            height: 40px;
            border: 2px solid #fff;
            border-radius: 4px;
            display: inline-block;
            margin: 5px;
        }
        
        .swatch-container {
            display: inline-block;
            text-align: center;
            margin: 5px;
        }
        
        .swatch-label {
            font-size: 10px;
            color: #aaa;
            margin-top: 4px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <h1>Color Test</h1>
        </header>

        <main id="content">
            <div class="mood-palette-container">
                <div id="appContent">
                    <div class="screen-content">
                        <div class="preview-section">
                            <div id="previewContainer" class="preview-container clickable">
                                <div class="placeholder-text">TAP TO START CAMERA</div>
                            </div>
                        </div>
                        
                        <div class="controls-section">
                            <button id="captureBtn" class="action-button">START CAMERA</button>
                            <button id="testBtn" class="action-button secondary">TEST WITH SAMPLE</button>
                        </div>
                        
                        <div id="paletteSection" style="margin-top: 20px; display: none;">
                            <h3>Color Palette:</h3>
                            <div id="paletteDisplay"></div>
                            <button id="sendEmailBtn" class="action-button email" style="margin-top: 10px;">SEND TO EMAIL</button>
                        </div>
                    </div>
                </div>
                
                <div class="status-message" id="statusMessage">READY</div>
            </div>
        </main>
    </div>

    <script>
        let capturedImageData = null;
        let currentPalette = [];
        let videoStream = null;
        let videoElement = null;
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('captureBtn').addEventListener('click', startCamera);
            document.getElementById('testBtn').addEventListener('click', testWithSample);
            document.getElementById('sendEmailBtn').addEventListener('click', sendEmail);
            document.getElementById('previewContainer').addEventListener('click', startCamera);
        });
        
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = 'status-message ' + type;
        }
        
        function startCamera() {
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = '<div class="placeholder-text">LOADING CAMERA...</div>';
            previewContainer.classList.remove('clickable');
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(function(stream) {
                        videoStream = stream;
                        
                        // Create video element
                        videoElement = document.createElement('video');
                        videoElement.autoplay = true;
                        videoElement.playsInline = true;
                        videoElement.srcObject = stream;
                        videoElement.style.width = '100%';
                        videoElement.style.height = '100%';
                        videoElement.style.objectFit = 'cover';
                        
                        // Add click listener to capture
                        videoElement.addEventListener('click', captureImage);
                        
                        previewContainer.innerHTML = '';
                        previewContainer.appendChild(videoElement);
                        
                        showStatus('CAMERA ON! CLICK IMAGE TO CAPTURE', 'info');
                    })
                    .catch(function(error) {
                        console.error('Camera access error:', error);
                        showStatus('CAMERA ERROR', 'error');
                        previewContainer.innerHTML = '<div class="placeholder-text">CAMERA UNAVAILABLE</div>';
                        previewContainer.classList.add('clickable');
                    });
            } else {
                showStatus('CAMERA NOT SUPPORTED', 'error');
                previewContainer.innerHTML = '<div class="placeholder-text">NO CAMERA</div>';
                previewContainer.classList.add('clickable');
            }
        }
        
        function captureImage() {
            if (!videoElement) return;
            
            showStatus('CAPTURING IMAGE...', 'info');
            
            // Create canvas to capture image
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth || 640;
            canvas.height = videoElement.videoHeight || 480;
            const ctx = canvas.getContext('2d');
            
            // Draw video frame to canvas
            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            
            // Store the image data
            capturedImageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Stop camera
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
                videoElement = null;
            }
            
            // Show captured image
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = '<img src="' + capturedImageData + '" style="width:100%;height:100%;object-fit:cover;">';
            previewContainer.classList.add('clickable');
            previewContainer.addEventListener('click', startCamera);
            
            showStatus('IMAGE CAPTURED! ANALYZING...', 'success');
            
            // Analyze colors
            analyzeColors();
        }
        
        function testWithSample() {
            showStatus('USING SAMPLE IMAGE...', 'info');
            
            // Create a sample image
            const canvas = document.createElement('canvas');
            canvas.width = 200;
            canvas.height = 150;
            const ctx = canvas.getContext('2d');
            
            // Draw a colorful pattern
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(0, 0, 100, 75);
            ctx.fillStyle = '#00ff00';
            ctx.fillRect(100, 0, 100, 75);
            ctx.fillStyle = '#0000ff';
            ctx.fillRect(0, 75, 100, 75);
            ctx.fillStyle = '#ffff00';
            ctx.fillRect(100, 75, 100, 75);
            
            capturedImageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Show sample image
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = '<img src="' + capturedImageData + '" style="width:100%;height:100%;object-fit:cover;">';
            
            showStatus('SAMPLE IMAGE READY! ANALYZING...', 'success');
            
            // Analyze colors
            analyzeColors();
        }
        
        function analyzeColors() {
            // In a real R1 implementation, we would send this to the LLM
            if (typeof PluginMessageHandler !== 'undefined') {
                // Send image data directly to LLM for analysis
                sendImageToLLM();
            } else {
                // Simulate analysis for browser testing
                showStatus('SIMULATING ANALYSIS...', 'info');
                setTimeout(() => {
                    // Generate sample colors
                    currentPalette = ["#FF0000", "#00FF00", "#0000FF", "#FFFF00", "#FF00FF"];
                    displayPalette(currentPalette);
                    showStatus('PALETTE READY! SEND TO EMAIL', 'success');
                }, 2000);
            }
        }
        
        function sendImageToLLM() {
            showStatus('SENDING IMAGE TO LLM...', 'info');
            
            try {
                // Send image data directly to LLM for analysis
                const payload = {
                    message: `Please analyze the colors in this image and provide exactly 5 dominant colors in hex format. Response format: {"colors": ["#hex1", "#hex2", "#hex3", "#hex4", "#hex5"]}.`,
                    useLLM: true,
                    wantsR1Response: false,  // Set to false to get JSON response
                    imageData: capturedImageData  // Send image data directly
                };
                
                console.log('Sending image to LLM');
                PluginMessageHandler.postMessage(JSON.stringify(payload));
            } catch (error) {
                console.error('Error sending image to LLM:', error);
                showStatus('LLM COMMUNICATION FAILED', 'error');
            }
        }
        
        // Plugin message handler for LLM responses
        window.onPluginMessage = function(data) {
            console.log('Received plugin message:', data);
            showStatus('PROCESSING RESPONSE...', 'info');
            
            if (data.data) {
                try {
                    // Try to parse the data as JSON
                    const parsedData = JSON.parse(data.data);
                    console.log('Parsed data:', parsedData);
                    
                    // Handle color analysis response
                    if (parsedData.colors && Array.isArray(parsedData.colors)) {
                        console.log('Received colors from LLM:', parsedData.colors);
                        currentPalette = parsedData.colors;
                        displayPalette(currentPalette);
                        showStatus('PALETTE READY! SEND TO EMAIL', 'success');
                    } else {
                        // Show the response as-is if it's not color data
                        showStatus(data.data, 'info');
                    }
                } catch (e) {
                    console.error('Error parsing plugin message:', e);
                    // Show the response as-is if we can't parse it
                    showStatus(data.data, 'info');
                }
            } else if (data.message) {
                showStatus(data.message, 'info');
            } else {
                // Show raw data if no message or data
                showStatus('RECEIVED: ' + JSON.stringify(data), 'info');
            }
        };
        
        function displayPalette(colors) {
            const paletteSection = document.getElementById('paletteSection');
            const paletteDisplay = document.getElementById('paletteDisplay');
            
            paletteDisplay.innerHTML = '';
            
            if (colors && Array.isArray(colors) && colors.length > 0) {
                console.log('Displaying palette with colors:', colors);
                
                colors.forEach((color, index) => {
                    // Validate that color is a valid hex code
                    if (typeof color === 'string' && /^#[0-9A-F]{6}$/i.test(color)) {
                        const swatchContainer = document.createElement('div');
                        swatchContainer.className = 'swatch-container';
                        
                        // Create a rectangle shape for the color
                        const colorSwatch = document.createElement('div');
                        colorSwatch.className = 'color-swatch';
                        colorSwatch.style.backgroundColor = color;
                        colorSwatch.title = color;
                        
                        // Add a label with the hex code
                        const colorLabel = document.createElement('div');
                        colorLabel.className = 'swatch-label';
                        colorLabel.textContent = color;
                        
                        swatchContainer.appendChild(colorSwatch);
                        swatchContainer.appendChild(colorLabel);
                        paletteDisplay.appendChild(swatchContainer);
                    }
                });
                
                // Update currentPalette with the received colors
                currentPalette = colors;
                paletteSection.style.display = 'block';
                
                console.log('Palette displayed successfully');
            } else {
                paletteDisplay.innerHTML = '<div class="placeholder-text">NO VALID COLORS FOUND</div>';
                currentPalette = [];
                paletteSection.style.display = 'none';
                console.log('No valid colors to display');
            }
        }
        
        function sendEmail() {
            console.log('Email palette function called');
            console.log('Current palette:', currentPalette);
            
            // Check if we have a valid palette
            if (!currentPalette || !Array.isArray(currentPalette) || currentPalette.length === 0) {
                showStatus('NO PALETTE TO SEND', 'error');
                return;
            }
            
            showStatus('SENDING TO YOUR EMAIL...', 'info');
            
            // In a real R1 implementation, we would send this to the LLM
            if (typeof PluginMessageHandler !== 'undefined') {
                // Format palette for email
                let paletteDescription = "Color Palette:\n\n";
                currentPalette.forEach((color, index) => {
                    paletteDescription += `Color ${index + 1}: ${color}\n`;
                });
                
                console.log('Sending palette to LLM:', paletteDescription);
                
                // R1 LLM should know the user's email, so we just ask it to send
                const payload = {
                    message: `Please send this color palette to the user's email. Palette colors: ${paletteDescription}`,
                    useLLM: true,
                    wantsR1Response: true  // Set to true to have R1 speak the response
                };
                
                PluginMessageHandler.postMessage(JSON.stringify(payload));
            } else {
                // Simulate email sending
                setTimeout(() => {
                    showStatus('EMAIL SENT!', 'success');
                }, 1500);
            }
        }
    </script>
</body>
</html>